## Домашнее задание № 3
### Название урока: Установка и настройка PostgreSQL

Цель:
- создавать дополнительный диск для уже существующей виртуальной машины, размечать его и делать на нем файловую систему
- переносить содержимое базы данных PostgreSQL на дополнительный диск
- переносить содержимое БД PostgreSQL между виртуальными машинами

### Описание/Пошаговая инструкция выполнения домашнего задания:
- создайте виртуальную машину c Ubuntu 20.04/22.04 LTS в ЯО/Virtual Box/докере
- поставьте на нее PostgreSQL 15 через sudo apt
- проверьте что кластер запущен через ```sudo -u postgres pg_lsclusters```
- зайдите из под пользователя postgres в psql и сделайте произвольную таблицу с произвольным содержимым
```postgres=# create table test(c1 text); postgres=# insert into test value ('1'); \q```
- остановите postgres например через ```sudo -u postgres pg_ctlcluster 15 main stop```
- создайте новый диск к ВМ размером 10GB
- добавьте свеже-созданный диск к виртуальной машине - надо зайти в режим ее редактирования и дальше выбрать пункт ```attach existing disk```
- проинициализируйте диск согласно инструкции и подмонтировать файловую систему, только не забывайте менять имя диска на актуальное, в вашем случае это скорее всего будет ```/dev/sdb``` - https://www.digitalocean.com/community/tutorials/how-to-partition-and-format-storage-devices-in-linux
- перезагрузите инстанс и убедитесь, что диск остается примонтированным (если не так смотрим в сторону fstab)
- сделайте пользователя postgres владельцем ```/mnt/data``` - ```chown -R postgres:postgres /mnt/data/```
- перенесите содержимое ```/var/lib/postgres/15``` в ```/mnt/data``` - ```mv /var/lib/postgresql/15/mnt/data```
- попытайтесь запустить кластер - ```sudo -u postgres pg_ctlcluster 15 main start```
- напишите получилось или нет и почему
- задание: найти конфигурационный параметр в файлах раположенных в /etc/postgresql/15/main который надо поменять и поменяйте его
напишите что и почему поменяли
- попытайтесь запустить кластер - ```sudo -u postgres pg_ctlcluster 15 main start```
- напишите получилось или нет и почему
- зайдите через через psql и проверьте содержимое ранее созданной таблицы
- задание со звездочкой *: не удаляя существующий инстанс ВМ сделайте новый, поставьте на его PostgreSQL, удалите файлы с данными из ```/var/lib/postgres```, перемонтируйте внешний диск который сделали ранее от первой виртуальной машины ко второй и запустите PostgreSQL на второй машине так чтобы он работал с данными на внешнем диске, расскажите как вы это сделали и что в итоге получилось.

### Выполнение домашнего задания

- Создана ВМ на Rocky Linux 9.6
- Поставлен на хост (не docker) PostgreSQL 18 командой ```dnf install -y postgresql18-server postgresql18 postgresql18-contrib```
- Проинициализован кластер командой ```/usr/pgsql-18/bin/postgresql-18-setup initdb```. Команда ```pg_lsclusters``` есть только на Ubuntu.
- Зашел под пользователем postgres и создал таблицу

```Вход```
![Вход](/screens/connect.png)

```Создание БД и таблицы```
![Создание БД и таблицы](/screens/createdb.png)

```Вставка данных```   
![Вставка данных](/screens/insertdata.png)

- Остановил инстанс PostgreSQL 18 командой ```systemctl stop postgresql-18```

- Создал новый диск на 10 ГБ и его проинициализоровал, создал на нем файловую систему и подмонтировал. Добавил его в ```/etc/fstab``` чтобы монтирование сохранилось после перезагрузки

```Смотрим диски, второй диск отображается как /dev/sdb и папка монтирование как /mnt/newdisk```  
![lsblk](/screens/lsblk.png)

```Чтобы монтирование сохранилось после перезагрузки```
![fstab](/screens/fstab.png)

- Выполнил команду ```chown -R postgres:postgres``` на каталоге ```/mnt/newdisk/data```
![chown](/screens/chown.png)

- Перенес данные с ```/var/lib/pgsql/18/data``` в ```/mnt/newdisk/data/18/data```
![Перенос](/screens/newlocation.png)

- Заменил в конфигурационном файле ```/usr/lib/systemd/system/postgresql-18.service``` переменную PGDATA
![Замена переменной](/screens/newpath.png)

- Запустил инстанс кластера командой ```systemctl start postgresql-18``` и увидел те данные, которые я недавно вставлял в таблицу БД

![Проверка статуса](/screens/checkdata.png)

#### Задание со звездочкой

- Установил на сервере на котором находится БД и клиенте (откуда буду монтировать) нужное мне ПО командой ```dnf install nfs-utils```
![Установка пакетов nfs](/screens/nfs.png)

- На сервере к которому будет подключаться клиент, отключил файервол командой ```systemctl stop firewalld``` и привел файл ```/etc/exports``` к следующему виду. Здесь указан IP адрес клиента, который будет подключаться к серверу с БД
![exports](/screens/exports.png)

- Запустил службу NFS на сервере с БД
![nfs-server status](/screens/nfs-server.png)

- Подключился по NFS к серверу с нашей БД
![Подключение по NFS](/screens/connect-nfs.png)

- Запустил на нашем сервере-клиенте БД командой ```systemctl start postgresql-18```
![Запуск PostgreSQL 18](/screens/start-postgres.png)